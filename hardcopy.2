  1 require 'pathname'
  2
  3 require "openid"
  4 require 'openid/extensions/sreg'
  5 require 'openid/extensions/pape'
  6 require 'openid/store/filesystem'
  7
  8 class ConsumerController < ApplicationController
  9   layout nil
 10
 11   def oauth_complete
 12     logger.debug env['omniauth.auth'].to_yaml
 13     logger.debug env['omniauth.origin']
 14     @oauth_url = "oauth://" + env['omniauth.auth']['provider'] + "/" + env['omniauth.auth']['uid']
 15     @image_url = env['omniauth.auth'].info.image
 16     session[:openid_url] = @oauth_url
 17     if getLoginUser
 18       @uname = getLoginUser.name
 19       flash[:success] = "Hello " + @uname + ". Login processing was successful."
 20       if getLoginUser.updateLastLoginTime
 21         flash[:success] += "(" + getLoginUser.last_login.to_s + ")";
 22       else
 23       end
 24       if env['omniauth.origin']
 25         flash[:alert] = "FromUrl is set: " + env['omniauth.origin']
 26         redirect_to env['omniauth.origin']
 27       else
 28         redirect_to :controller => 'mypage', :action => 'index'
 29       end
 30     else
 31       if env['omniauth.origin']
 32         redirect_to :action => 'signup', :image => @image_url,:fromUrl => env['omniauth.origin']
 33       else
 34         redirect_to :action => 'signup', :image => @image_url
 35       end
 36     end
 37   end
 38
 39   def index
 40     # render an openid form
 41   end
 42
 43   def start
 44     begin
 45       identifier = params[:openid_identifier]
 46       if identifier.nil?
 47         flash[:error] = "Enter an OpenID identifier"
 48         redirect_to :action => 'index'
 49         return
 50       end
 51       oidreq = consumer.begin(identifier)
 52     rescue OpenID::OpenIDError => e
 53       flash[:error] = "Discovery failed for #{identifier}: #{e}"
 54       redirect_to :action => 'index'
 55       return
 56     end
 57     if params[:use_sreg]
 58       sregreq = OpenID::SReg::Request.new
 59       # required fields
consumer_controller.rb [ruby][utf-8][unix]                                                                                                                                                         67 25/217
"consumer_controller.rb" 217L, 7382C written
